{% schema %}
{
  "name": "GSAP Luxury Hero",
  "settings": [
    {
      "type": "header",
      "content": "Slider Configuration"
    },
    {
      "type": "checkbox",
      "id": "autoplay",
      "label": "Enable Autoplay",
      "default": true
    },
    {
      "type": "range",
      "id": "autoplay_speed",
      "min": 3,
      "max": 12,
      "step": 1,
      "unit": "s",
      "label": "Autoplay Duration",
      "default": 6
    },
    {
      "type": "range",
      "id": "transition_speed",
      "min": 0.5,
      "max": 3.0,
      "step": 0.1,
      "unit": "s",
      "label": "Transition Smoothness",
      "default": 1.2,
      "info": "Higher values create a slower, more luxurious transition."
    },
    {
      "type": "header",
      "content": "Layout Settings"
    },
    {
      "type": "select",
      "id": "desktop_height",
      "label": "Desktop Height",
      "options": [
        { "value": "100vh", "label": "Full Screen (100vh)" },
        { "value": "80vh", "label": "Large (80vh)" },
        { "value": "700px", "label": "Fixed (700px)" }
      ],
      "default": "100vh"
    },
    {
      "type": "select",
      "id": "mobile_height",
      "label": "Mobile Height",
      "options": [
        { "value": "100vh", "label": "Full Screen (100vh)" },
        { "value": "80vh", "label": "Large Mobile (80vh)" },
        { "value": "70vh", "label": "Medium Mobile (70vh)" },
        { "value": "500px", "label": "Fixed (500px)" }
      ],
      "default": "80vh"
    },
    {
      "type": "header",
      "content": "Global Typography"
    },
    {
      "type": "range",
      "id": "heading_size",
      "min": 40,
      "max": 150,
      "step": 5,
      "unit": "px",
      "label": "Desktop Heading Size",
      "default": 100
    },
    {
      "type": "color",
      "id": "text_color",
      "label": "Global Text Color",
      "default": "#ffffff"
    }
  ],
  "blocks": [
    {
      "type": "slide",
      "name": "Slide",
      "settings": [
        {
          "type": "image_picker",
          "id": "image",
          "label": "Desktop Image"
        },
        {
          "type": "image_picker",
          "id": "mobile_image",
          "label": "Mobile Image (Specific)"
        },
        {
          "type": "text",
          "id": "subheading",
          "label": "Subheading",
          "default": "new collection"
        },
        {
          "type": "text",
          "id": "heading",
          "label": "Heading",
          "default": "VENUS"
        },
        {
          "type": "textarea",
          "id": "text",
          "label": "Description",
          "default": "Freshwater pearls & trios of precious gems. Everyday elegance."
        },
        {
          "type": "select",
          "id": "alignment",
          "label": "Content Alignment",
          "options": [
            { "value": "left", "label": "Left" },
            { "value": "center", "label": "Center" },
            { "value": "right", "label": "Right" }
          ],
          "default": "center"
        },
        {
          "type": "header",
          "content": "Button"
        },
        {
          "type": "text",
          "id": "button_label",
          "label": "Button Label",
          "default": "EXPLORE"
        },
        {
          "type": "url",
          "id": "button_link",
          "label": "Button Link"
        },
        {
          "type": "header",
          "content": "Overlay"
        },
        {
          "type": "color",
          "id": "overlay_color",
          "label": "Overlay Color",
          "default": "#000000"
        },
        {
          "type": "range",
          "id": "overlay_opacity",
          "min": 0,
          "max": 90,
          "step": 5,
          "unit": "%",
          "label": "Overlay Opacity",
          "default": 30
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "GSAP Luxury Hero",
      "blocks": [
        { "type": "slide", "settings": { "heading": "VENUS" } },
        { "type": "slide", "settings": { "heading": "AURA" } }
      ]
    }
  ]
}
{% endschema %}

<style>
  @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Montserrat:wght@200;300;400;600&display=swap');

  .hqi-gsap-hero-{{ section.id }} {
    position: relative;
    width: 100%;
    height: {{ section.settings.desktop_height }};
    overflow: hidden;
    background: #000;
    font-family: 'Montserrat', sans-serif;
    color: {{ section.settings.text_color }};
  }

  .hqi-gsap-track {
    display: flex;
    height: 100%;
    width: 100%;
    position: relative;
  }

  .hqi-gsap-slide {
    position: absolute;
    top: 0; left: 0;
    width: 100%; height: 100%;
    display: flex;
    align-items: center;
    visibility: hidden;
    opacity: 0;
  }

  .hqi-gsap-slide.active {
    visibility: visible;
    opacity: 1;
    z-index: 2;
  }

  .hqi-gsap-bg {
    position: absolute;
    top: 0; left: 0; width: 100%; height: 100%;
    z-index: 1;
    transform: scale(1.1); 
  }

  .hqi-gsap-bg img {
    width: 100%; height: 100%;
    object-fit: cover;
    display: block;
  }

  .hqi-gsap-overlay {
    position: absolute;
    top: 0; left: 0; width: 100%; height: 100%;
    z-index: 2;
  }

  .hqi-gsap-container {
    position: relative;
    z-index: 3;
    width: 100%;
    max-width: 1400px;
    margin: 0 auto;
    padding: 0 40px;
    height: 100%;
    display: flex;
    flex-direction: column;
    justify-content: center; /* Keeps content vertically centered */
  }

  .hqi-gsap-content {
    max-width: 800px;
    opacity: 0;
    /* Removed transform: translateY(30px) to keep it fixed */
  }

  /* Alignment Logic */
  .align-left { text-align: left; margin-right: auto; align-items: flex-start; }
  .align-center { text-align: center; margin-left: auto; margin-right: auto; align-items: center; }
  .align-right { text-align: right; margin-left: auto; align-items: flex-end; }

  .hqi-gsap-subheading {
    font-size: 13px;
    text-transform: uppercase;
    letter-spacing: 0.5em;
    margin-bottom: 25px;
    display: block;
    font-weight: 300;
  }

  .hqi-gsap-heading {
    font-family: 'Cinzel', serif;
    font-size: clamp(36px, 6vw, {{ section.settings.heading_size }}px);
    font-weight: 400;
    letter-spacing: 0.25em;
    margin: 0 0 35px 0;
    line-height: 1.1;
    color: inherit; 
  }

  .hqi-gsap-desc {
    font-size: clamp(14px, 1.5vw, 18px);
    line-height: 1.8;
    margin-bottom: 50px;
    opacity: 0.8;
    font-weight: 200;
    max-width: 600px;
  }

  .align-center .hqi-gsap-desc { margin-left: auto; margin-right: auto; }
  .align-right .hqi-gsap-desc { margin-left: auto; }

  .hqi-gsap-btn {
    display: inline-block;
    padding: 15px 55px;
    border: 1px solid rgba(255,255,255,0.3);
    background: transparent;
    color: inherit;
    text-decoration: none;
    font-size: 11px;
    letter-spacing: 0.4em;
    transition: all 0.4s ease;
    backdrop-filter: blur(10px);
  }

  .hqi-gsap-btn:hover {
    background: #fff;
    color: #000;
    border-color: #fff;
    letter-spacing: 0.5em;
  }

  /* UI Controls */
  .hqi-gsap-nav {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    z-index: 20;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 20px;
    font-size: 10px;
    letter-spacing: 0.3em;
    text-transform: uppercase;
    color: inherit;
    opacity: 0.6;
    transition: 0.3s;
  }
  .hqi-gsap-nav:hover { opacity: 1; }
  .hqi-gsap-nav-line { width: 50px; height: 1px; background: currentColor; }

  .hqi-gsap-prev { left: 50px; }
  .hqi-gsap-next { right: 50px; flex-direction: row-reverse; }

  .hqi-gsap-dots {
    position: absolute;
    bottom: 50px;
    left: 50%;
    transform: translateX(-50%);
    z-index: 20;
    display: flex;
    gap: 15px;
  }
  .hqi-gsap-dot {
    width: 8px; height: 8px;
    border: 1px solid currentColor;
    border-radius: 50%;
    cursor: pointer;
    transition: 0.3s;
  }
  .hqi-gsap-dot.active { background: currentColor; scale: 1.2; }

  /* Mobile Responsive */
  @media (max-width: 768px) {
    .hqi-gsap-hero-{{ section.id }} { height: {{ section.settings.mobile_height }}; }
    .hqi-gsap-nav { display: none; }
    .hqi-gsap-container { padding: 0 20px; }
    .hqi-gsap-content { text-align: center; margin: 0 auto; width: 100%; }
    
    .hqi-gsap-heading { margin-bottom: 20px; letter-spacing: 0.15em; }
    .hqi-gsap-subheading { margin-bottom: 15px; font-size: 11px; }
    .hqi-gsap-desc { margin: 0 auto 30px auto; max-width: 100%; font-size: 13px; }
    
    .hqi-gsap-btn { padding: 12px 30px; }
    .hqi-gsap-dots { bottom: 30px; }
  }
  /* ✅ Make the fixed text truly fixed in the middle like huts.com */
#Slider-{{ section.id }} .hqi-gsap-fixed-layer{
  position: absolute;
  inset: 0;
  z-index: 10;
  display: flex;
  align-items: center;      /* middle vertically */
  pointer-events: none;     /* so background scroll doesn't block */
}

#Slider-{{ section.id }} .hqi-gsap-fixed-layer .hqi-gsap-btn{
  pointer-events: auto;     /* button clickable */
}

#Slider-{{ section.id }} .hqi-fixed-content{
  opacity: 1 !important;
  transform: none !important;
}

</style>

{% assign first_block = section.blocks.first %}

<div class="hqi-gsap-hero-{{ section.id }}" id="Slider-{{ section.id }}">
  <div class="hqi-gsap-track">
    {% for block in section.blocks %}
      <div
        class="hqi-gsap-slide {% if forloop.first %}active{% endif %}"
        data-index="{{ forloop.index0 }}"
        data-align="align-{{ block.settings.alignment }}"
        data-subheading="{{ block.settings.subheading | escape }}"
        data-heading="{{ block.settings.heading | escape }}"
        data-text="{{ block.settings.text | strip_newlines | escape }}"
        data-btn-label="{{ block.settings.button_label | escape }}"
        data-btn-link="{{ block.settings.button_link }}"
        {{ block.shopify_attributes }}
      >
        <div class="hqi-gsap-bg">
          <picture>
            {% if block.settings.mobile_image != blank %}
              <source media="(max-width: 768px)" srcset="{{ block.settings.mobile_image | image_url: width: 800 }}">
            {% endif %}
            {% if block.settings.image != blank %}
              <img src="{{ block.settings.image | image_url: width: 2800 }}" alt="{{ block.settings.heading | escape }}" loading="lazy">
            {% else %}
              {{ 'lifestyle-2' | placeholder_svg_tag: 'hqi-placeholder' }}
            {% endif %}
          </picture>
        </div>

        <div class="hqi-gsap-overlay"
             style="background: {{ block.settings.overlay_color }}; opacity: {{ block.settings.overlay_opacity | divided_by: 100.0 }};">
        </div>
      </div>
    {% endfor %}
  </div>

  <!-- ✅ FIXED TEXT LAYER (always centered) -->
  <div class="hqi-gsap-fixed-layer">
    <div class="hqi-gsap-container">
      <div class="hqi-gsap-content hqi-fixed-content align-{{ first_block.settings.alignment }}">
        <span class="hqi-gsap-subheading">{{ first_block.settings.subheading }}</span>
        <h2 class="hqi-gsap-heading">{{ first_block.settings.heading }}</h2>
        <p class="hqi-gsap-desc">{{ first_block.settings.text }}</p>

        {% if first_block.settings.button_label != blank %}
          <a href="{{ first_block.settings.button_link | default: '#' }}" class="hqi-gsap-btn">
            {{ first_block.settings.button_label }}
          </a>
        {% else %}
          <a href="#" class="hqi-gsap-btn" style="display:none;"></a>
        {% endif %}
      </div>
    </div>
  </div>

  <div class="hqi-gsap-nav hqi-gsap-prev" onclick="moveSlide{{ section.id | replace: '-', '_' }}(-1)">
    <div class="hqi-gsap-nav-line"></div><span>Prev</span>
  </div>
  <div class="hqi-gsap-nav hqi-gsap-next" onclick="moveSlide{{ section.id | replace: '-', '_' }}(1)">
    <div class="hqi-gsap-nav-line"></div><span>Next</span>
  </div>

  <div class="hqi-gsap-dots">
    {% for block in section.blocks %}
      <div class="hqi-gsap-dot {% if forloop.first %}active{% endif %}" onclick="goToSlide{{ section.id | replace: '-', '_' }}({{ forloop.index0 }})"></div>
    {% endfor %}
  </div>
</div>


<script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>

<script>
(function() {
  gsap.registerPlugin(ScrollTrigger);

  const hero = document.getElementById("Slider-{{ section.id }}");
  if (!hero) return;

  const slides = Array.from(hero.querySelectorAll(".hqi-gsap-slide"));
  const dots = Array.from(hero.querySelectorAll(".hqi-gsap-dot"));
  const fixed = hero.querySelector(".hqi-fixed-content");
  if (!slides.length || !fixed) return;

  const subEl = fixed.querySelector(".hqi-gsap-subheading");
  const headEl = fixed.querySelector(".hqi-gsap-heading");
  const descEl = fixed.querySelector(".hqi-gsap-desc");
  const btnEl  = fixed.querySelector(".hqi-gsap-btn");

  const total = slides.length;
  const speed = {{ section.settings.transition_speed }};
  let activeIndex = 0;
  let isUpdating = false;

  // remove duplicate triggers for this hero (editor safety)
  ScrollTrigger.getAll().forEach(st => {
    if (st && st.trigger === hero) st.kill(true);
  });

  // background init
  gsap.set(slides, { autoAlpha: 0, visibility: "hidden" });
  gsap.set(slides[0], { autoAlpha: 1, visibility: "visible" });

  // background timeline (only bg changes)
  const tl = gsap.timeline();
  for (let i = 0; i < total - 1; i++) {
    const cur = slides[i];
    const next = slides[i + 1];
    const t = i * 1; // each step = 1 unit

    tl.set(next, { visibility: "visible" }, t);
    tl.to(cur, { autoAlpha: 0, duration: 1, ease: "none" }, t);
    tl.fromTo(next, { autoAlpha: 0 }, { autoAlpha: 1, duration: 1, ease: "none" }, t);

    const curBg = cur.querySelector(".hqi-gsap-bg");
    const nextBg = next.querySelector(".hqi-gsap-bg");
    if (curBg) tl.to(curBg, { scale: 1.15, duration: 1, ease: "none" }, t);
    if (nextBg) tl.fromTo(nextBg, { scale: 1.2 }, { scale: 1, duration: 1, ease: "none" }, t);

    tl.set(cur, { visibility: "hidden" }, t + 1);
  }

  function applyContent(idx) {
    if (isUpdating) return;
    isUpdating = true;

    const s = slides[idx];
    const align = s.dataset.align || "align-center";
    const sub = s.dataset.subheading || "";
    const head = s.dataset.heading || "";
    const desc = s.dataset.text || "";
    const bl = s.dataset.btnLabel || "";
    const link = s.dataset.btnLink || "#";

    // dots + active class
    slides.forEach((sl, i) => sl.classList.toggle("active", i === idx));
    dots.forEach((d, i) => d.classList.toggle("active", i === idx));

    // alignment
    fixed.classList.remove("align-left", "align-center", "align-right");
    fixed.classList.add(align);

    // smooth text swap like huts
    gsap.to(fixed, {
      autoAlpha: 0,
      duration: Math.max(0.2, speed * 0.25),
      ease: "power2.out",
      onComplete: () => {
        subEl.textContent = sub;
        headEl.textContent = head;
        descEl.textContent = desc;

        if (bl && bl.trim() !== "") {
          btnEl.style.display = "inline-block";
          btnEl.textContent = bl;
          btnEl.href = link || "#";
        } else {
          btnEl.style.display = "none";
        }

        gsap.to(fixed, {
          autoAlpha: 1,
          duration: Math.max(0.25, speed * 0.35),
          ease: "power2.out",
          onComplete: () => {
            isUpdating = false;
          }
        });
      }
    });
  }

  const st = ScrollTrigger.create({
    trigger: hero,
    start: "top top",
    end: () => "+=" + (window.innerHeight * (total - 1)),
    pin: true,
    scrub: 1.2,
    anticipatePin: 1,
    invalidateOnRefresh: true,
    fastScrollEnd: true,
    snap: total > 1 ? {
      snapTo: 1 / (total - 1),
      duration: { min: 0.2, max: 0.6 },
      delay: 0.02,
      ease: "power2.out"
    } : false,
    animation: tl,
    onUpdate: (self) => {
      const idx = Math.round(self.progress * (total - 1));
      if (idx !== activeIndex) {
        activeIndex = idx;
        applyContent(idx);
      }
    }
  });

  function scrollToIndex(index) {
    const i = Math.max(0, Math.min(total - 1, index));
    const y = st.start + (st.end - st.start) * (i / (total - 1));
    window.scrollTo({ top: y, behavior: "smooth" });
  }

  window.goToSlide{{ section.id | replace: '-', '_' }} = function(index) {
    scrollToIndex(index);
  };

  window.moveSlide{{ section.id | replace: '-', '_' }} = function(dir) {
    scrollToIndex((activeIndex + dir + total) % total);
  };

  // initial content from first slide dataset
  applyContent(0);

  {% if section.settings.autoplay %}
    setInterval(() => {
      window.moveSlide{{ section.id | replace: '-', '_' }}(1);
    }, {{ section.settings.autoplay_speed | times: 1000 }});
  {% endif %}

  ScrollTrigger.refresh();
})();
</script>

